apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: openclaw
  namespace: argocd
  finalizers:
    - argoproj.io/resources-finalizer
spec:
  project: default

  source:
    repoURL: https://serhanekicii.github.io/openclaw-helm
    chart: openclaw
    targetRevision: 1.3.14
    helm:
      values: |
        chromium:
          enabled: true

        app-template:
          controllers:
            main:
              strategy: RollingUpdate
              rollingUpdate:
                unavailable: 0
                surge: 1
              initContainers:
                patch-trusted-proxies:
                  image:
                    repository: ghcr.io/openclaw/openclaw
                    tag: "2026.2.12"
                  dependsOn:
                    - init-config
                  command:
                    - node
                    - -e
                    - |
                      const https = require('https');
                      const fs = require('fs');
                      const token = fs.readFileSync('/var/run/secrets/kubernetes.io/serviceaccount/token', 'utf8');
                      const ca = fs.readFileSync('/var/run/secrets/kubernetes.io/serviceaccount/ca.crt');
                      const opts = {
                        hostname: 'kubernetes.default.svc',
                        path: '/api/v1/namespaces/ingress-nginx/pods?labelSelector=app.kubernetes.io/component=controller',
                        headers: { Authorization: 'Bearer ' + token },
                        ca: ca
                      };
                      https.get(opts, (res) => {
                        let data = '';
                        res.on('data', (c) => data += c);
                        res.on('end', () => {
                          const pods = JSON.parse(data);
                          const ips = pods.items.map(p => p.status.podIP).filter(Boolean);
                          const cfg = JSON.parse(fs.readFileSync('/home/node/.openclaw/openclaw.json', 'utf8'));
                          cfg.gateway = cfg.gateway || {};
                          cfg.gateway.trustedProxies = ips;
                          fs.writeFileSync('/home/node/.openclaw/openclaw.json', JSON.stringify(cfg, null, 2));
                          console.log('[patch-trusted-proxies] Updated trustedProxies:', ips);
                        });
                      }).on('error', (e) => {
                        console.error('[patch-trusted-proxies] Failed:', e.message);
                        process.exit(1);
                      });
              containers:
                main:
                  env:
                    TZ: Asia/Seoul
                  envFrom:
                    - secretRef:
                        name: openclaw-secret
                chromium:
                  image:
                    repository: docker.io/zenika/alpine-chrome
                    tag: "124"
          persistence:
            data:
              type: persistentVolumeClaim
              size: 5Gi
              accessMode: ReadWriteOnce
              advancedMounts:
                main:
                  patch-trusted-proxies:
                    - path: /home/node/.openclaw
                  main:
                    - path: /home/node/.openclaw
            tmp:
              type: emptyDir
              advancedMounts:
                main:
                  patch-trusted-proxies:
                    - path: /tmp

  destination:
    server: https://kubernetes.default.svc
    namespace: openclaw

  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: openclaw-secrets
  namespace: argocd
  finalizers:
    - argoproj.io/resources-finalizer
spec:
  project: default

  source:
    repoURL: https://github.com/tlarbals824/infrastructure.git
    targetRevision: main
    path: k8s/apps/openclaw

  destination:
    server: https://kubernetes.default.svc
    namespace: openclaw

  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true