apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: openclaw
  namespace: argocd
  finalizers:
    - argoproj.io/resources-finalizer
spec:
  project: default

  source:
    repoURL: https://serhanekicii.github.io/openclaw-helm
    chart: openclaw
    targetRevision: 1.3.14
    helm:
      values: |
        chromium:
          enabled: true

        app-template:
          controllers:
            main:
              strategy: RollingUpdate
              rollingUpdate:
                unavailable: 0
                surge: 1
              initContainers:
                setup-python:
                  image:
                    repository: docker.io/python
                    tag: "3.11-slim"
                  dependsOn:
                    - init-config
                  command:
                    - python3
                    - -c
                    - |
                      import os, subprocess
                      venv_dir = '/home/node/.openclaw/python'
                      scripts_dir = '/home/node/.openclaw/scripts'
                      os.makedirs(scripts_dir, exist_ok=True)
                      pip_bin = os.path.join(venv_dir, 'bin', 'pip')
                      if not os.path.isfile(pip_bin):
                          print('[setup-python] Creating venv with pip...')
                          subprocess.run(['python3', '-m', 'venv', venv_dir], check=True)
                          print('[setup-python] venv created')
                      else:
                          print('[setup-python] venv already exists, skipping')
                      print('[setup-python] Setup complete')
                patch-trusted-proxies:
                  image:
                    repository: ghcr.io/openclaw/openclaw
                    tag: "2026.2.12"
                  dependsOn:
                    - init-config
                  command:
                    - node
                    - -e
                    - |
                      const https = require('https');
                      const fs = require('fs');
                      const token = fs.readFileSync('/var/run/secrets/kubernetes.io/serviceaccount/token', 'utf8');
                      const ca = fs.readFileSync('/var/run/secrets/kubernetes.io/serviceaccount/ca.crt');
                      const opts = {
                        hostname: 'kubernetes.default.svc',
                        path: '/api/v1/namespaces/ingress-nginx/pods?labelSelector=app.kubernetes.io/component=controller',
                        headers: { Authorization: 'Bearer ' + token },
                        ca: ca
                      };
                      https.get(opts, (res) => {
                        let data = '';
                        res.on('data', (c) => data += c);
                        res.on('end', () => {
                          const pods = JSON.parse(data);
                          const ips = pods.items.map(p => p.status.podIP).filter(Boolean);
                          const raw = fs.readFileSync('/home/node/.openclaw/openclaw.json', 'utf8');
                          const cfg = (new Function('return (' + raw + ')'))();
                          cfg.gateway = cfg.gateway || {};
                          cfg.gateway.trustedProxies = ips;
                          cfg.agents = cfg.agents || {};
                          cfg.agents.defaults = cfg.agents.defaults || {};
                          cfg.agents.defaults.model = cfg.agents.defaults.model || {};
                          cfg.agents.defaults.model.primary = 'openai-codex/gpt-5.3-codex';
                          if (cfg.agents.list && cfg.agents.list.length > 0) { cfg.agents.list[0].model = 'openai-codex/gpt-5.3-codex'; }
                          fs.writeFileSync('/home/node/.openclaw/openclaw.json', JSON.stringify(cfg, null, 2));
                          console.log('[patch-trusted-proxies] Updated trustedProxies:', ips);
                          console.log('[patch-trusted-proxies] Set primary/main model: openai-codex/gpt-5.3-codex');
                        });
                      }).on('error', (e) => {
                        console.error('[patch-trusted-proxies] Failed:', e.message);
                        process.exit(1);
                      });
              containers:
                main:
                  env:
                    TZ: Asia/Seoul
                    VIRTUAL_ENV: /home/node/.openclaw/python
                    PYTHONPATH: /home/node/.openclaw/python/lib/python3.11/site-packages
                    PATH: /home/node/.openclaw/python/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
                  envFrom:
                    - secretRef:
                        name: openclaw-secret
                chromium:
                  image:
                    repository: docker.io/zenika/alpine-chrome
                    tag: "124"
          persistence:
            data:
              type: persistentVolumeClaim
              size: 5Gi
              accessMode: ReadWriteOnce
              advancedMounts:
                main:
                  init-config:
                    - path: /home/node/.openclaw
                  setup-python:
                    - path: /home/node/.openclaw
                  patch-trusted-proxies:
                    - path: /home/node/.openclaw
                  main:
                    - path: /home/node/.openclaw
            tmp:
              type: emptyDir
              advancedMounts:
                main:
                  setup-python:
                    - path: /tmp
                  patch-trusted-proxies:
                    - path: /tmp

  destination:
    server: https://kubernetes.default.svc
    namespace: openclaw

  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: openclaw-secrets
  namespace: argocd
  finalizers:
    - argoproj.io/resources-finalizer
spec:
  project: default

  source:
    repoURL: https://github.com/tlarbals824/infrastructure.git
    targetRevision: main
    path: k8s/apps/openclaw

  destination:
    server: https://kubernetes.default.svc
    namespace: openclaw

  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true