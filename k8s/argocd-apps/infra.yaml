apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: infra-argocd
  namespace: argocd
  finalizers:
    - argoproj.io/resources-finalizer
spec:
  project: default

  source:
    repoURL: https://github.com/tlarbals824/infrastructure.git
    targetRevision: main
    path: k8s/infra/argocd

  destination:
    server: https://kubernetes.default.svc
    namespace: argocd

  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: infra-cert-manager
  namespace: argocd
  finalizers:
    - argoproj.io/resources-finalizer
spec:
  project: default

  source:
    repoURL: https://charts.jetstack.io
    chart: cert-manager
    targetRevision: v1.17.2
    helm:
      values: |
        crds:
          enabled: true

  destination:
    server: https://kubernetes.default.svc
    namespace: cert-manager

  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: infra-cert-manager-issuers
  namespace: argocd
  finalizers:
    - argoproj.io/resources-finalizer
spec:
  project: default

  source:
    repoURL: https://github.com/tlarbals824/infrastructure.git
    targetRevision: main
    path: k8s/infra/cert-manager

  destination:
    server: https://kubernetes.default.svc
    namespace: cert-manager

  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: infra-argo-rollouts
  namespace: argocd
  finalizers:
    - argoproj.io/resources-finalizer
spec:
  project: default

  source:
    repoURL: https://argoproj.github.io/argo-helm
    chart: argo-rollouts
    targetRevision: 2.39.1
    helm:
      values: |
        dashboard:
          enabled: true

  destination:
    server: https://kubernetes.default.svc
    namespace: argo-rollouts

  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
      - ServerSideApply=true
  ignoreDifferences:
    - group: apiextensions.k8s.io
      kind: CustomResourceDefinition
      jsonPointers:
        - /status
        - /spec/preserveUnknownFields
---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: infra-ingress-nginx
  namespace: argocd
  finalizers:
    - argoproj.io/resources-finalizer
spec:
  project: default

  source:
    repoURL: https://kubernetes.github.io/ingress-nginx
    chart: ingress-nginx
    targetRevision: 4.13.1
    helm:
      values: |
        controller:
          # CrowdSec Lua bouncer 지원 이미지 (mainline v1.12+에서 Lua 제거됨)
          image:
            registry: docker.io
            image: crowdsecurity/controller
            tag: v1.13.2
            digest: sha256:4575be24781cad35f8e58437db6a3f492df2a3167fed2b6759a6ff0dc3488d56
          replicaCount: 2
          updateStrategy:
            type: RollingUpdate
            rollingUpdate:
              maxUnavailable: 1
          minAvailable: 1
          config:
            lua-shared-dicts: "crowdsec_cache: 50m"
            plugins: "crowdsec"
          extraVolumes:
            - name: crowdsec-bouncer-plugin
              emptyDir: {}
          extraVolumeMounts:
            - name: crowdsec-bouncer-plugin
              mountPath: /etc/nginx/lua/plugins/crowdsec
              readOnly: true
          extraInitContainers:
            - name: init-crowdsec-bouncer
              image: index.docker.io/crowdsecurity/lua-bouncer-plugin:v1.1.2
              env:
                - name: API_URL
                  value: "http://crowdsec-service.crowdsec.svc.cluster.local:8080"
                - name: API_KEY
                  valueFrom:
                    secretKeyRef:
                      name: crowdsec-bouncer-key
                      key: BOUNCER_KEY
                - name: BOUNCER_CONFIG
                  value: "/crowdsec/crowdsec-bouncer.conf"
                - name: BAN_TEMPLATE_PATH
                  value: "/etc/nginx/lua/plugins/crowdsec/templates/ban.html"
                - name: CAPTCHA_TEMPLATE_PATH
                  value: "/etc/nginx/lua/plugins/crowdsec/templates/captcha.html"
              command: ["sh", "-c", "sh /docker_start.sh && cp -R /crowdsec/* /lua_plugins/crowdsec/"]
              volumeMounts:
                - name: crowdsec-bouncer-plugin
                  mountPath: /lua_plugins/crowdsec
          service:
            loadBalancerIP: "134.185.104.125"
            annotations:
              oci.oraclecloud.com/load-balancer-type: "nlb"

  destination:
    server: https://kubernetes.default.svc
    namespace: ingress-nginx

  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: infra-ingress-nginx-config
  namespace: argocd
  finalizers:
    - argoproj.io/resources-finalizer
spec:
  project: default

  source:
    repoURL: https://github.com/tlarbals824/infrastructure.git
    targetRevision: main
    path: k8s/infra/ingress-nginx

  destination:
    server: https://kubernetes.default.svc
    namespace: ingress-nginx

  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: infra-crowdsec
  namespace: argocd
  finalizers:
    - argoproj.io/resources-finalizer
spec:
  project: default

  source:
    repoURL: https://crowdsecurity.github.io/helm-charts
    chart: crowdsec
    targetRevision: 0.22.0
    helm:
      values: |
        container_runtime: containerd

        image:
          repository: docker.io/crowdsecurity/crowdsec

        lapi:
          env:
            - name: BOUNCER_KEY_ingress
              value: "${CROWDSEC_BOUNCER_KEY}"
          persistentVolume:
            data:
              enabled: true
              size: 1Gi
            config:
              enabled: true
              size: 100Mi
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 500m
              memory: 256Mi

        agent:
          acquisition:
            - namespace: ingress-nginx
              podName: ingress-nginx-controller-*
              program: nginx
          env:
            - name: COLLECTIONS
              value: "crowdsecurity/nginx"
            - name: PARSERS
              value: "crowdsecurity/nginx-logs"
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 500m
              memory: 256Mi

  destination:
    server: https://kubernetes.default.svc
    namespace: crowdsec

  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: infra-crowdsec-config
  namespace: argocd
  finalizers:
    - argoproj.io/resources-finalizer
spec:
  project: default

  source:
    repoURL: https://github.com/tlarbals824/infrastructure.git
    targetRevision: main
    path: k8s/infra/crowdsec

  destination:
    server: https://kubernetes.default.svc
    namespace: crowdsec

  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: infra-sealed-secrets
  namespace: argocd
  finalizers:
    - argoproj.io/resources-finalizer
spec:
  project: default

  source:
    repoURL: https://bitnami-labs.github.io/sealed-secrets
    chart: sealed-secrets
    targetRevision: 2.18.0
    helm:
      values: |
        fullnameOverride: sealed-secrets-controller

  destination:
    server: https://kubernetes.default.svc
    namespace: kube-system

  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
